/* convert images into FOLD file format.
more info at https://github.com/robbykraft/tofold
more info on the FOLD format https://github.com/edemaine/fold
(c) Robby Kraft, MIT License */(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.tofold=b()})(this,function(){'use strict';var f=Math.abs,g=Math.sqrt;function a(b){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},a(b)}function b(a){return c(a)||d(a)||e()}function c(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function d(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function e(){throw new TypeError("Invalid attempt to spread non-iterable instance")}var h="undefined"!=typeof window&&"undefined"!=typeof window.document,i="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node,j="object"===("undefined"==typeof self?"undefined":a(self))&&self.constructor&&"DedicatedWorkerGlobalScope"===self.constructor.name,k=!i&&h?window:{};if(i){var l=require("xmldom"),m=l.DOMParser,n=l.XMLSerializer;k.DOMParser=m,k.XMLSerializer=n,k.document=new m().parseFromString("<!DOCTYPE html><title>a</title>","text/html")}var o={black:"#000000",silver:"#c0c0c0",gray:"#808080",white:"#ffffff",maroon:"#800000",red:"#ff0000",purple:"#800080",fuchsia:"#ff00ff",green:"#008000",lime:"#00ff00",olive:"#808000",yellow:"#ffff00",navy:"#000080",blue:"#0000ff",teal:"#008080",aqua:"#00ffff",orange:"#ffa500",aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",blanchedalmond:"#ffebcd",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",oldlace:"#fdf5e6",olivedrab:"#6b8e23",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",whitesmoke:"#f5f5f5",yellowgreen:"#9acd32"},p=Object.keys(o),q=function(c){var d=0,e=0,f=0,h=255;return 4===c.length?(d="0x".concat(c[1]).concat(c[1]),e="0x".concat(c[2]).concat(c[2]),f="0x".concat(c[3]).concat(c[3])):7===c.length?(d="0x".concat(c[1]).concat(c[2]),e="0x".concat(c[3]).concat(c[4]),f="0x".concat(c[5]).concat(c[6])):5===c.length?(d="0x".concat(c[1]).concat(c[1]),e="0x".concat(c[2]).concat(c[2]),f="0x".concat(c[3]).concat(c[3]),h="0x".concat(c[4]).concat(c[4])):9===c.length&&(d="0x".concat(c[1]).concat(c[2]),e="0x".concat(c[3]).concat(c[4]),f="0x".concat(c[5]).concat(c[6]),h="0x".concat(c[7]).concat(c[8])),[+(d/255),+(e/255),+(f/255),+(h/255)]},r=function(a){if(null==a||"string"!=typeof a)return"U";var b=[0,0,0,1];"#"===a[0]?b=q(a):-1!==p.indexOf(a)&&(b=q(o[a]));var d=.05;return b[0]<d&&b[1]<d&&b[2]<d?"U":b[0]>b[1]&&b[0]-b[2]>d?"M":b[2]>b[1]&&b[2]-b[0]>d?"V":"U"},s=1e-6,t=function(a){var b=a.map(function(a){return a*a}).reduce(function(a,b){return a+b},0);return g(b)},u=function(a,b){return a>s&&a<1-s&&b>s&&b<1-s},v=function(a,b,c,d,e){function g(c,a){return c[0]*a[1]-a[0]*c[1]}var h=5<arguments.length&&void 0!==arguments[5]?arguments[5]:s,i=g(b,d);if(!(f(i)<h)){var j=g([c[0]-a[0],c[1]-a[1]],d),k=g([a[0]-c[0],a[1]-c[1]],b),l=j/i;return e(l,k/-i,h)?[a[0]+b[0]*l,a[1]+b[1]*l]:void 0}},w={core:{EPSILON:s,magnitude:t,normalize:function(a){var b=t(a);return 0===b?a:a.map(function(a){return a/b})},equivalent:function(c,a){for(var b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:s,d=0;d<c.length;d+=1)if(f(c[d]-a[d])>b)return!1;return!0},point_on_edge_exclusive:function(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:s,e=[b[0]-c[0],b[1]-c[1]],h=[b[0]-a[0],b[1]-a[1]],i=[c[0]-a[0],c[1]-a[1]],j=g(e[0]*e[0]+e[1]*e[1]),k=g(h[0]*h[0]+h[1]*h[1]),l=g(i[0]*i[0]+i[1]*i[1]);return f(j-k-l)<d},intersection:{edge_edge_exclusive:function(a,b,c,d,e){var f=[b[0]-a[0],b[1]-a[1]],g=[d[0]-c[0],d[1]-c[1]];return v(a,f,c,g,u,e)}}}},x=function(){for(var a=Math.max,c=arguments.length,d=Array(c),e=0;e<c;e++)d[e]=arguments[e];return a.apply(Math,b(d.filter(function(a){return void 0!==a}).map(function(a){return a.length})))},y={vertices:function(a){var b=a.vertices_coords,c=a.vertices_faces,d=a.vertices_vertices;return x([],b,c,d)},edges:function(a){var b=a.edges_vertices,c=a.edges_faces;return x([],b,c)},faces:function(a){var b=a.faces_vertices,c=a.faces_edges;return x([],b,c)}},z=function(a,b,c){var d=y[b](a),e=Array(d).fill(!1);c.forEach(function(a){e[a]=!0});var f=0,g=e.map(function(a){return a?--f:f});if(0===c.length)return g;var h="".concat(b,"_"),i="_".concat(b),j=Object.keys(a),k=j.map(function(a){return a.substring(0,h.length)===h?a:void 0}).filter(function(a){return void 0!==a}),l=j.map(function(a){return a.substring(a.length-i.length,a.length)===i?a:void 0}).filter(function(a){return void 0!==a});return l.forEach(function(b){return a[b].forEach(function(c,d){return a[b][d].forEach(function(c,e){a[b][d][e]+=g[c]})})}),k.forEach(function(b){a[b]=a[b].filter(function(a,b){return!e[b]})}),g},A=function(c,a){return c[0]===a[0]&&c[1]===a[1]||c[0]===a[1]&&c[1]===a[0]},B=function(a){var b=a.vertices_coords,c=a.edges_vertices,d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:w.core.EPSILON,e=c.map(function(a){return a.map(function(a){return b[a]})});return e.map(function(a){return b.filter(function(b){return w.core.point_on_edge_exclusive(b,a[0],a[1],d)})})},C=function(a){var b=a.vertices_coords,c=a.edges_vertices,d=c.map(function(a){return a.map(function(a){return b[a]})}),e=d.map(function(a){return[a[1][0]-a[0][0],a[1][1]-a[0][1]]}),h=e.map(function(a){return g(a[0]*a[0]+a[1]*a[1])}),i=e.map(function(a,b){return[a[0]/h[b],a[1]/h[b]]});return i.map(function(a){return .707<f(a[0])})},D=function(a){for(var b=a.vertices_coords,c=a.edges_vertices,d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:w.core.EPSILON,e=c.length,f=c.map(function(a){return a.map(function(a){return b[a]})}),g=Array.from(Array(e-1)).map(function(){return[]}),h=0;h<f.length-1;h+=1)for(var k=h+1;k<f.length;k+=1)g[h][k]=w.core.intersection.edge_edge_exclusive(f[h][0],f[h][1],f[k][0],f[k][1],d);for(var l=Array.from(Array(e)).map(function(){return[]}),m=0;m<f.length-1;m+=1)for(var n=m+1;n<f.length;n+=1)null!=g[m][n]&&(l[m].push(g[m][n]),l[n].push(g[m][n]));return l},E=function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:w.core.EPSILON,c=function(c,a){return c[0]-a[0]},d=function(c,a){return c[1]-a[1]},g=C(a),h=a.edges_vertices.map(function(b){return b.map(function(b){return a.vertices_coords[b]})});h.forEach(function(a,b){return a.sort(g[b]?c:d)});var k=D(a,b),l=B(a,b),m=k.map(function(b,a){return b.concat(l[a])});m.forEach(function(a,b){return a.sort(g[b]?c:d)});var n=m.map(function(a){return Array.from(Array(a.length-1)).map(function(b,c){return[a[c],a[c+1]]})});n=n.map(function(a){return a.filter(function(a){return!1===a.map(function(c,d){return f(a[0][d]-a[1][d])<b}).reduce(function(c,a){return c&&a},!0)})});for(var o=n.map(function(a,b){return a.map(function(){return b})}).reduce(function(c,a){return c.concat(a)},[]),p=n.map(function(a){return a.reduce(function(c,a){return c.concat(a)},[])}).reduce(function(c,a){return c.concat(a)},[]),q=0,r=n.map(function(a){return a.map(function(){return[q++,q++]})}).reduce(function(c,a){return c.concat(a)},[]),s=Array.from(Array(p.length)).map(function(){return[]}),t=0;t<p.length-1;t+=1)for(var e=t+1;e<p.length;e+=1)s[t][e]=w.core.equivalent(p[t],p[e],b);var u=p.map(function(){});s.forEach(function(a,b){return a.forEach(function(a,c){a&&(u[c]=void 0===u[b]?b:u[b])})});var v=u.map(function(a){return void 0!==a});u.forEach(function(a,b){void 0===a&&(u[b]=b)}),r.forEach(function(a,b){return a.forEach(function(a,c){r[b][c]=u[a]})});for(var x=Array.from(Array(r.length)).map(function(){return[]}),y=0;y<r.length-1;y+=1)for(var E=y+1;E<r.length;E+=1)x[y][E]=A(r[y],r[E]);var F=r.map(function(){});x.forEach(function(a,b){return a.forEach(function(a,c){a&&(F[b]=void 0===F[c]?c:F[c])})});var G=F.map(function(a){return void 0===a});F.forEach(function(a,b){void 0===a&&(F[b]=b)});var H=r.filter(function(a,b){return G[b]}),I=o.filter(function(a,b){return G[b]}),J={vertices_coords:p,edges_vertices:H};!0=="edges_assignment"in a&&(J.edges_assignment=I.map(function(b){return a.edges_assignment[b]})),!0=="edges_foldAngle"in a&&(J.edges_foldAngle=I.map(function(b){return a.edges_foldAngle[b]}));var K=v.map(function(a,b){return a?b:void 0}).filter(function(a){return void 0!==a});return z(J,"vertices",K),J},F=function(a){var b=a.edges_vertices,c={};return b.map(function(a){return a.sort(function(c,a){return c-a}).join(" ")}).forEach(function(a,b){c[a]=b}),c},G=function(a,b,c){for(var d=a.vertices_vertices,e=[b,c];e[0]!==e[e.length-1];){var f=d[e[e.length-1]],g=f.indexOf(e[e.length-2]),h=f[(g+1)%f.length];e.push(h)}return e.pop(),e},H=function(b){if(null==b.vertices_coords||1>b.vertices_coords.length)return[];for(var c=0,d=1;d<b.vertices_coords.length;d+=1)b.vertices_coords[d][1]<b.vertices_coords[c][1]&&(c=d);if(-1===c)return[];for(var a=b.vertices_vertices[c],e=a.map(function(d){return[b.vertices_coords[d][0]-b.vertices_coords[c][0],b.vertices_coords[d][1]-b.vertices_coords[c][1]]}),f=e.map(function(a){return w.core.normalize(a)}).map(function(a){return a[0]}),g=-1,h=-Infinity,j=0;j<f.length;j+=1)f[j]>h&&(g=j,h=f[j]);var k=G(b,c,a[g]),l=F(b),m=k.map(function(a,b,c){return[c[b],c[(b+1)%c.length]].sort(function(c,a){return c-a}).join(" ")}),n=m.map(function(a){return l[a]});return n},I=k.Segmentize||require("svg-segmentize"),J=k.FOLD||require("fold"),K={V:180,v:180,M:-180,m:-180},L=function(a){return K[a]||0},M=function(){return{file_spec:1.1,file_creator:"Rabbit Ear",file_classes:["singleModel"],frame_title:"",frame_classes:["creasePattern"],frame_attributes:["2D"],vertices_coords:[],vertices_vertices:[],vertices_faces:[],edges_vertices:[],edges_faces:[],edges_assignment:[],edges_foldAngle:[],edges_length:[],faces_vertices:[],faces_edges:[]}},N=function(a,b){var c=M(),d=c.vertices_coords.length,e=I(a);c.vertices_coords=e.map(function(a){return[[a[0],a[1]],[a[2],a[3]]]}).reduce(function(c,a){return c.concat(a)},c.vertices_coords),c.edges_vertices=e.map(function(a,b){return[d+2*b,d+2*b+1]}),c.edges_assignment=e.map(function(b){return b[4]}).map(function(a){return null==a?"U":r(a.stroke)});var f=E(c,b.epsilon);return J.convert.edges_vertices_to_vertices_vertices_sorted(f),J.convert.vertices_vertices_to_faces_vertices(f),J.convert.faces_vertices_to_faces_edges(f),f.edges_foldAngle=f.edges_assignment.map(function(b){return L(b)}),!1!==b.boundary&&H(f).forEach(function(a){f.edges_assignment[a]="B"}),f},O=function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof a){var c=new k.DOMParser().parseFromString(a,"text/xml").documentElement;return N(c,b)}return N(a,b)};return O.core={segmentize:function(){},fragment:E},O});
